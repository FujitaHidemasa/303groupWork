<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="com.example.voidr.repository.PasswordResetPinMapper">

	<insert id="insert"
		parameterType="com.example.voidr.entity.PasswordResetPin"
		useGeneratedKeys="true" keyProperty="id">
		INSERT INTO password_reset_pin (email, pin, expire_at, consumed)
		VALUES (#{email}, #{pin}, #{expireAt}, FALSE)
	</insert>

	<select id="findActive"
		resultType="com.example.voidr.entity.PasswordResetPin">
		SELECT id, email, pin, expire_at AS expireAt, consumed, created_at AS
		createdAt
		FROM password_reset_pin
		WHERE email = #{email}
		AND pin = #{pin}
		AND consumed = FALSE
		AND expire_at > NOW()
		ORDER BY id DESC
		LIMIT 1
	</select>

	<update id="consume">
		UPDATE password_reset_pin SET consumed = TRUE WHERE id = #{id}
	</update>

	<select id="countIssuedRecently" resultType="int">
		SELECT COUNT(*)
		FROM password_reset_pin
		WHERE email = #{email}
		AND created_at > NOW() - (#{minutes} || ' minutes')::interval
	</select>

</mapper>
