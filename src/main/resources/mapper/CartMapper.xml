<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.voidr.repository.CartMapper">

	<!-- Cart と Item の入れ子構造を CartView にマップ -->
	<resultMap id="CartViewMap"
		type="com.example.voidr.view.CartView">
		<association property="cart"
			javaType="com.example.voidr.entity.Cart">
			<id property="id" column="c_id" />
			<result property="cartListId" column="cartlist_id" />
			<result property="itemId" column="item_id" />
			<result property="quantity" column="quantity" />
			<result property="hold" column="is_hold" />
			<result property="updatedAt" column="c_updated_at" />
		</association>
		<association property="item"
			javaType="com.example.voidr.entity.Item">
			<id property="id" column="i_id" />
			<result property="name" column="item_name" />
			<result property="price" column="price" />
			<result property="overview" column="overview" />
			<result property="isDownload" column="is_download" />
			<result property="isDeleted" column="is_deleted" />
			<result property="thumbsImageName" column="thumbs_image_name" />
			<result property="createdAt" column="i_created_at" />
			<result property="updatedAt" column="i_updated_at" />
		</association>
	</resultMap>

	<resultMap id="CartWithItemResultMap"
		type="com.example.voidr.entity.Cart">
		<id property="id" column="c_id" />
		<result property="cartListId" column="cartlist_id" />
		<result property="itemId" column="c_item_id" />
		<result property="quantity" column="quantity" />
		<result property="isHold" column="is_hold" />

		<association property="item"
			javaType="com.example.voidr.entity.Item">
			<id property="id" column="i_id" />
			<result property="name" column="item_name" />
			<result property="price" column="item_price" />
			<result property="isDeleted" column="is_deleted" />
		</association>
	</resultMap>



	<!-- 表示用：ユーザーのカートを JOIN で取得 -->
	<select id="findViewsByUserId" parameterType="long"
		resultMap="CartViewMap">
		SELECT
		-- cart
		c.id AS c_id,
		c.cartlist_id AS cartlist_id,
		c.item_id AS item_id,
		c.quantity AS quantity,
		c.is_hold AS is_hold,
		c.updated_at AS c_updated_at,
		-- item
		i.id AS i_id,
		i.name AS item_name,
		i.price AS price,
		i.overview AS overview,
		i.is_download AS is_download,
		i.is_deleted AS is_deleted,
		i.thumbs_image_name AS thumbs_image_name,
		i.created_at AS i_created_at,
		i.updated_at AS i_updated_at
		FROM cart c
		JOIN cart_list cl ON
		c.cartlist_id = cl.id
		JOIN item i ON c.item_id = i.id
		WHERE cl.user_id = #{userId}
		ORDER BY c.id DESC
	</select>

	<!-- 合計金額 -->
	<select id="sumTotalByUserId" parameterType="long"
		resultType="int">
		SELECT COALESCE(SUM(i.price * c.quantity), 0)
		FROM cart c
		JOIN cart_list cl ON c.cartlist_id = cl.id
		JOIN item i ON c.item_id = i.id
		WHERE cl.user_id = #{userId}
			AND i.is_deleted = FALSE
	</select>

	<!-- バッジ用：合計数量 -->
	<select id="countItemsByUserId" parameterType="long"
		resultType="int">
		SELECT COALESCE(SUM(c.quantity), 0)
		FROM cart c
		JOIN cart_list cl ON c.cartlist_id = cl.id
		JOIN item i ON c.item_id = i.id
		WHERE cl.user_id = #{userId}
			AND i.is_deleted = FALSE
	</select>

	<!-- ✅ ユーザー名でカート一覧取得 -->
	<select id="findByUsername" parameterType="string"
		resultMap="CartWithItemResultMap">
		SELECT
		-- Cart
		c.id AS c_id,
		c.cartlist_id,
		c.item_id AS
		c_item_id,
		c.quantity,
		c.is_hold,
		-- Item
		i.id AS i_id,
		i.name AS
		item_name,
		i.price AS
		item_price
		FROM cart c
		JOIN cart_list cl ON
		c.cartlist_id = cl.id
		JOIN item i ON c.item_id = i.id
		JOIN login_user u
		ON cl.user_id = u.id
		WHERE u.username = #{username}
	</select>



	<!-- ✅ ユーザー名で全カート削除 -->
	<delete id="deleteAllByUsername" parameterType="string">
		DELETE FROM cart
		WHERE cartlist_id IN (
		SELECT cl.id FROM cart_list cl
		JOIN login_user u
		ON cl.user_id = u.id
		WHERE u.username = #{username}
		)
	</delete>


	<!-- UPSERT（同一 cartlist_id + item_id は数量加算） -->
	<insert id="upsert"
		parameterType="com.example.voidr.entity.Cart" useGeneratedKeys="true"
		keyProperty="id">
		INSERT INTO cart (cartlist_id, item_id, quantity, is_hold,
		updated_at)
		VALUES (#{cartListId}, #{itemId}, #{quantity}, FALSE,
		CURRENT_TIMESTAMP)
		ON CONFLICT (cartlist_id, item_id)
		DO UPDATE SET
			quantity = cart.quantity + EXCLUDED.quantity,
			updated_at = CURRENT_TIMESTAMP
	</insert>

	<!-- 数量を直接セット -->
	<update id="updateQuantityByCart"
		parameterType="com.example.voidr.entity.Cart">
		UPDATE cart
		SET quantity = #{quantity},
			updated_at = CURRENT_TIMESTAMP
		WHERE id = #{id}
	</update>

	<!-- 削除 -->
	<delete id="deleteById" parameterType="long">
		DELETE FROM cart WHERE id = #{id}
	</delete>

	<delete id="deleteByCartListId" parameterType="long">
		DELETE FROM cart
		WHERE cartlist_id = #{cartListId}
	</delete>

</mapper>