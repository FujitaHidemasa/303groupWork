<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>お届け先管理｜VOIDR</title>
  <link rel="stylesheet" th:href="@{/css/mypage/mypage.css}">
  <link rel="stylesheet" th:href="@{/css/ec/header.css}">
  <style>
    		/* マイページのCSSが上書きしたヘッダーの位置を戻す */
    		.fixed-header {
    			position: fixed;
    			top: 0;
    			left: 0;
    			width: 100%;
    			z-index: 9999;
    		}

    		/* カートアイコンのバッジが崩れないようにする */
    		.cart-icon-wrap {
    			position: relative !important;
    			display: inline-flex !important;
    			align-items: center !important;
    		}

    		.cart-count-badge {
    			position: absolute !important;
    			top: -5px !important;
    			right: -8px !important;
    		}

    		/* マイページでもカートバッジを完全な丸に固定 */
    		.cart-count-badge {
    		    position: absolute !important;
    		    top: -5px !important;
    		    right: -8px !important;

    		    background-color: red !important;
    		    color: white !important;
    		    font-size: 12px !important;
    		    font-weight: bold !important;

    		    height: 18px !important;          /* 高さ固定 */
    		    min-width: 18px !important;       /* 最小サイズは正円 */
    		    padding: 0 6px !important;        /* 2桁以上の時に横幅が広がる */

    		    border-radius: 50% !important;    /* 丸/楕円 */
    		    display: none;                     /* 初期は非表示 */
    		    text-align: center;
    		    line-height: 18px;                 /* 縦中央揃え */
    		    white-space: nowrap;               /* 折り返さない */
    		    box-sizing: border-box;            /* paddingを含めた幅調整 */
    		}
    	</style>
</head>
<body>

  <!-- 共通ヘッダー -->
  <header th:replace="fragments/header :: header"></header>

  <main class="mypage-container">
	<aside class="mypage-sidebar">
				<h2>メニュー</h2>
				<ul>
					<li>
						<a th:href="@{/mypage/orders}" 
						   th:classappend="${currentPath == '/mypage/orders'} ? 'active'">
						   購入履歴
						</a>
					</li>
					<li>
						<a th:href="@{/mypage/edit}" 
						   th:classappend="${currentPath == '/mypage/edit'} ? 'active'">
						   会員情報変更
						</a>
					</li>
					<li>
						<a th:href="@{/mypage/address}" 
						   th:classappend="${currentPath == '/mypage/address'} ? 'active'">
						   お届け先管理
						</a>
					</li>
					<li>
						<a th:href="@{/favorites/{userId}(userId=${#authentication.principal.id})}" 
						   th:classappend="${currentPath == '/mypage/wishlist'} ? 'active'"
						   sec:authorize="isAuthenticated()">
						   お気に入り
						</a>

					</li>
					<li>
						<a th:href="@{/mypage/delete}" 
						   th:classappend="${currentPath == '/mypage/delete'} ? 'active'">
						   退会手続き
						</a>
					</li>
				</ul>
			</aside>

    <section class="mypage-content">
      <h2>お届け先管理</h2>

      <div class="address-list">
        <h3>登録済み住所</h3>

        <ul>
          <li th:each="addr : ${addresses}">
            <div>
              <p th:text="${addr.recipientName}">氏名</p>
              <p th:text="'〒' + ${addr.postalCode}">郵便番号</p>
              <p th:text="${addr.address}">住所</p>
              <p th:text="${addr.phone}">電話番号</p>
            </div>

            <!-- 削除フォーム（見た目は同じ） -->
            <form th:action="@{/mypage/address/delete}" method="post" style="margin-top:10px;">
              <input type="hidden" name="id" th:value="${addr.id}">
              <button class="btn" type="submit">削除</button>
            </form>
          </li>
        </ul>

        <h3>新しいお届け先を追加</h3>

        <form class="member-form"
              th:action="@{/mypage/address/add}"
              method="post"
              th:object="${newAddress}">
          
          <div class="form-group">
            <label>氏名</label>
            <input type="text"
				 th:field="*{recipientName}" 
				 th:classappend="${#fields.hasErrors('recipientName')} ? 'input-error'" 
				 placeholder="例：山田太郎">
				 
			<p class="error" th:if="${#fields.hasErrors('recipientName')}"
				th:errors="*{recipientName}"></p>
          </div>

          <div class="form-group">
            <label>郵便番号</label>
            <input type="text" 
				th:field="*{postalCode}" 
				th:classappend="${#fields.hasErrors('postalCode')} ? 'input-error'"
				placeholder="例：160-0022">
				
			<p class="error" th:if="${#fields.hasErrors('postalCode')}"
				th:errors="*{postalCode}"></p>
          </div>

          <div class="form-group">
            <label>住所</label>
            <input type="text" 
				th:field="*{address}" 
				th:classappend="${#fields.hasErrors('address')} ? 'input-error'"
				placeholder="例：東京都新宿区1-2-3">
				
			<p class="error" th:if="${#fields.hasErrors('address')}"
				th:errors="*{address}"></p>
          </div>

          <div class="form-group">
            <label>電話番号</label>
            <input type="text" 
				th:field="*{phone}" 
				th:classappend="${#fields.hasErrors('phone')} ? 'input-error'"
				placeholder="例：080-1234-5678">
			<p class="error" th:if="${#fields.hasErrors('phone')}"
				th:errors="*{phone}"></p>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn">追加</button>
          </div>
        </form>

      </div>
    </section>

  </main>
  


  <footer class="main-footer">
    <p>&copy; 2025 VOIDR STORE. All rights reserved.</p>
  </footer>

  <!-- ▼ 登録完了ポップアップ -->
  <div id="popup" class="popup">
    <div class="popup-content">
      <p>新しいお届け先を登録しました！</p>
      <button class="popup-close" onclick="closePopup()">OK</button>
    </div>
  </div>
  
	<script>
	    // URL に ?success がついていたらモーダルを開く
	    const url = new URL(window.location.href);

	    if (url.searchParams.get("success") !== null) {
	        document.getElementById("popup").classList.add("show");
	    }

	    // 閉じるボタン
	    function closePopup() {
	        document.getElementById("popup").classList.remove("show");
	    }
	</script>
</body>
</html>
