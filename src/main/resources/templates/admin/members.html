<!--/* ============================================================
  会員管理ページ（2025/11/20 更新）

  【現在の実装状況】
  ・会員一覧（ID・表示名・メールアドレス・権限・登録日・有効／退会ステータス）を表示
  ・ID／名前／メールアドレスで検索できる
  ・削除ボタンで enabled = false にして「退会扱い」（論理削除）
  ・退会済みユーザーはログインできないように制御済み

  【補足】
  ・Service / Mapper は既存の AccountService / AccountMapper を利用
  ・/admin/** へのアクセス制限は後日 Spring Security で設定予定
=============================================================== */-->

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja"
	th:replace="layout/admin_base :: admin_base(~{::content}, '会員管理', ~{::assets})">

<th:block th:fragment="assets">
	<link rel="stylesheet" th:href="@{/css/admin/members.css}">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

</th:block>

<th:block th:fragment="content">
	<div class="table-container">
		<section class="section">
			<h1>会員管理</h1>

			<div class="search-area">
				<form th:action="@{/admin/members}" method="get" class="search-area"
					style="display:flex; gap:8px; width:100%;">

					<input type="text" name="keyword" placeholder="ユーザーID・氏名・メールアドレスで検索" th:value="${keyword}"
						style="flex:1;">

					<button type="submit">検索</button>
				</form>
				
				</div>
				<div class="status-tabs">
				    <a th:href="@{/admin/members(status='all')}"
				       th:classappend="${status == 'all'} ? 'active' : ''">すべて</a>

				    <a th:href="@{/admin/members(status='active')}"
				       th:classappend="${status == 'active'} ? 'active' : ''">有効</a>

				    <a th:href="@{/admin/members(status='disabled')}"
				       th:classappend="${status == 'disabled'} ? 'active' : ''">退会済</a>

			</div>
			<table>
				<thead>
					<tr>
						<th>ID</th>
						<th>ユーザーID</th>
						<th>氏名</th>
						<th>権限</th>
						<th>Email</th>
						<th>登録日</th>
						<th>状態</th>
						<th>操作</th>
					</tr>
				</thead>
				<tbody>
					<tr th:each="m : ${members}" th:classappend="${!m.enabled} ? 'disabled-row' : ''">
						<td th:text="${m.id}"></td>
						<td th:text="${m.username}"></td>
						<td th:text="${m.displayName}"></td>
						<td>
							<form th:action="@{/admin/members/changeAuthority}" method="post" style="display:flex; gap:6px;">
							    <input type="hidden" name="username" th:value="${m.username}">
								<select name="authority">
								    <option value="USER"
								            th:selected="${m.authority.name() == 'USER'}">USER</option>

								    <option value="ADMIN"
								            th:selected="${m.authority.name() == 'ADMIN'}">ADMIN</option>
								</select>


							    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
							    <button type="submit" class="btn btn-update"
								onclick="return confirm('このユーザーの権限を変更しますか？');">変更</button>
							</form>

						</td>
						<td th:text="${m.email}"></td>
						<td th:text="${#temporals.format(m.createdAt, 'yyyy/MM/dd')}"></td>
						<td th:text="${m.enabled} ? '有効' : '退会'"></td>
						<td>
							<div class="actions">
								<!-- 編集ボタンはまだダミーのまま（必要なら disabled にしておく） -->
								<!--編集ボタンは削除しました　藤田11/20-->
								

								<!-- 削除（退会）フォーム -->
								<th:block th:if="${m.enabled}">
									<form th:action="@{/admin/members/delete}" method="post" style="display:inline;">
										<input type="hidden" name="username" th:value="${m.username}">
										<input type="hidden" th:name="${_csrf.parameterName}"
											th:value="${_csrf.token}" />
											<button type="submit" class="btn btn-gun"
											        onclick="return confirm('本当に強制退会させますか？⚠️');">
											    <i class="fas fa-gun"></i> 強制退会
											</button>

									</form>
								</th:block>

								<!-- 退会済みの場合は「退会済」表示だけ -->
								<span th:if="${!m.enabled}" style="color: #aaa;">退会済</span>
							</div>
						</td>
					</tr>
				</tbody>
			</table>
		</section>
	</div>
	
	<script>
	document.addEventListener("DOMContentLoaded", () => {
	  const deleteForms = document.querySelectorAll("form[action='/admin/members/delete']");

	  deleteForms.forEach(form => {
	    form.addEventListener("submit", function(e) {
	      e.preventDefault();

	      if (!confirm("本当に強制退会させますか？⚠️")) return;

	      const row = this.closest("tr");

	      // ホログラム崩壊エフェクト発動
	      row.classList.add("holo-break");

	      // 完全崩壊後に削除処理 (0.65秒後)
	      setTimeout(() => form.submit(), 650);
	    });
	  });
	});
	</script>





</th:block>

</html>