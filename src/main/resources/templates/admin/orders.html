<!-- ============================================================
  注文管理（2025/11/19 更新）

  【実装済み】
  ・このページでは全ユーザーの注文履歴を一覧表示し、
    ユーザー名、商品名、価格、購入日時などを確認できるようにしています。（DB連携済み）
  ・管理画面専用の Controller（AdminOrderController）を追加済み。

  【未実装部分】
  ・特になし（今後、必要な場合に追記）

  【補足】
  ・Service / Mapper は既存の OrderService / OrderMapper を再利用しています。
  ・Spring Security により /admin/** を認可制限予定。
============================================================ -->

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja"
	th:replace="layout/admin_base :: admin_base(~{::content}, '注文管理', ~{::assets})">

	<th:block th:fragment="assets">
		<link rel="stylesheet" th:href="@{/css/admin/orders.css}">
	</th:block>

<th:block th:fragment="content">
	<div class="table-container">
	<div class="section">
		<h1>注文管理</h1>

		<!-- 注文がない場合 -->
		<p th:if="${#lists.isEmpty(orderLists)}" style="margin-bottom:16px; color:#666;">
			現在、登録されている注文はありません。
		</p>

		<!-- フラッシュメッセージ（ステータス更新結果など） -->
		<p th:if="${successMessage != null}" th:text="${successMessage}" style="color: #0a0; margin-bottom: 12px;"></p>

		<!-- 注文一覧テーブル -->
		<div th:if="${!#lists.isEmpty(orderLists)}">
			<table>
				<thead>
					<tr>
						<th>注文ID</th>
						<th>注文日</th>
						<th>氏名</th>
						<th>点数</th>
						<th>合計金額</th>
						<th>ステータス</th>
						<th>ステータス更新</th>
						<th>詳細</th>
					</tr>
				</thead>
				<tbody>
					<tr th:each="ol : ${orderLists}">
						<!-- 注文ID -->
						<td th:text="${ol.id}">1001</td>

						<!-- 注文日 -->
						<td th:text="${#temporals.format(ol.createdAt, 'yyyy/MM/dd HH:mm')}">
							2025/11/01 10:00
						</td>

						<!-- 会員名（displayName） -->
						<td th:text="${ol.displayName}">大阪 次郎</td>
						
						<!-- 点数 -->
						<td th:text="${itemCountMap[ol.id]} + '点'">3点</td>

						<!-- 合計金額（商品小計） -->
						<td th:text="${#numbers.formatInteger(totalPriceMap[ol.id], 1, 'COMMA')} + '円'">
							8,200円
						</td>
						
						<!-- ステータスバッジ表示 -->
						<td>
						    <span th:class="'badge ' +
						        (${ol.status} == 'NEW' ? 'badge-a' :
						        (${ol.status} == 'SHIPPED' ? 'badge-b' : 'badge-c'))">

						        <span th:switch="${ol.status}">
						            <span th:case="'NEW'">注文受付</span>
						            <span th:case="'SHIPPED'">出荷済み</span>
						            <span th:case="'CANCELLED'">キャンセル</span>
						        </span>
						    </span>
						</td>

						<!-- ステータス更新（未出荷 / 出荷済み）-->
						<td>
							<form th:action="@{/admin/orders/{id}/status(id=${ol.id})}" method="post"
								class="status-form">
								<!-- CSRFトークン -->
								<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

								<select name="status">
									<option value="NEW" th:selected="${ol.status == 'NEW'}">注文受付</option>
									<option value="SHIPPED" th:selected="${ol.status == 'SHIPPED'}">出荷済み</option>
									<option value="CANCELLED" th:selected="${ol.status == 'CANCELLED'}">キャンセル</option>
								</select>
								<button type="submit" class="btn btn-edit">更新</button>
							</form>
						</td>

						<!-- 詳細ボタン -->
						<td>
							<a class="btn btn-edit"
								th:href="@{/admin/orders/{id}(id=${ol.id})}">
								詳細
							</a>
						</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>
	</section>
</th:block>

</html>