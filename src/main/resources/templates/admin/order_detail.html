<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja"
      th:replace="layout/admin_base :: admin_base(~{::content}, '注文詳細', ~{::assets})">

<th:block th:fragment="assets">
	<link rel="stylesheet" th:href="@{/css/admin/orders.css}">
	<link rel="stylesheet" th:href="@{/css/admin/order_de.css}">
</th:block>

<th:block th:fragment="content">
	<div class="table-container">
<section class="section">

		<h1>注文詳細</h1>

	<!-- ===== 注文概要カード ===== -->

		<div class="detail-block">
			
			<!-- ===== ステータス表示＋更新 ===== -->
			<div class="status-section">

				<div class="status-label">
					<b>現在のステータス：</b>
					<span th:class="'badge ' +
					    (status eq 'NEW' ? 'badge-a' :
					    (status eq 'SHIPPED' ? 'badge-b' : 'badge-c'))">
						<span th:switch="${status}">
							<span th:case="'NEW'">注文受付</span>
							<span th:case="'SHIPPED'">出荷済み</span>
							<span th:case="'CANCELLED'">キャンセル</span>
						</span>
					</span>
				</div>

				<form th:action="@{/admin/orders/{id}/status(id=${orderListId})}"
					  method="post" class="status-update-form">

					<select name="status" class="status-select">
						<option value="NEW" th:selected="${status == 'NEW'}">注文受付</option>
						<option value="SHIPPED" th:selected="${status == 'SHIPPED'}">出荷済み</option>
						<option value="CANCELLED" th:selected="${status == 'CANCELLED'}">キャンセル</option>
					</select>

					<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

					<button type="submit" class="btn btn-edit status-btn">更新</button>
				</form>

			</div>

			<h2 class="sub-title">注文概要</h2>

			<p><b>注文ID：</b>
				<span th:text="${orderListId}"></span>
			</p>

			<p>
				<b>会員：</b>
				<span th:text="${orderDisplayName}">田中 太郎</span>
				（<span th:text="${orderUserName}">sample_user</span>）
			</p>

			<p th:if="${orderCreatedAt != null}">
				<b>注文日：</b>
				<span th:text="${#temporals.format(orderCreatedAt, 'yyyy/MM/dd HH:mm')}"></span>
			</p>

			<p th:if="${orderUpdatedAt != null}">
				<b>最終更新：</b>
				<span th:text="${#temporals.format(orderUpdatedAt, 'yyyy/MM/dd HH:mm')}"></span>
			</p>


			<!-- ===== 支払い / 配送情報 ===== -->
			<h2 class="sub-title" style="margin-top:20px;">支払い / 配送</h2>

			<p>
				<b>支払い方法：</b>
				<span th:text="${paymentMethod}"></span>
			</p>

			<p>
				<b>配送先：</b>
				<span th:text="${address}"></span>
			</p>

			<p th:if="${deliveryDate != null}">
				<b>配達希望：</b>
				<span th:text="${#temporals.format(deliveryDate, 'yyyy/MM/dd')}"></span>
				<span th:text="${deliveryTime}"></span>
			</p>

			<!-- ===== 金額情報 ===== -->
			<h2 class="sub-title" style="margin-top:20px;">支払金額</h2>

			<p>
				<b>商品小計：</b>
				<span th:text="${#numbers.formatInteger(totalPrice,1,'COMMA')}"></span>円
			</p>

			<p>
				<b>送料：</b>
				<span th:text="${shippingFee == 0 ? '無料' : #numbers.formatInteger(shippingFee,1,'COMMA') + '円'}"></span>
			</p>

			<p>
				<b>支払金額合計：</b>
				<span th:text="${#numbers.formatInteger(finalTotal,1,'COMMA')}"></span>円
			</p>

		</div>

	<!-- ===== 注文商品 ===== -->
	<h2 class="sub-title" style="margin-top:30px;">注文商品</h2>

	<table>
		<thead>
			<tr>
				<th>商品画像</th>
				<th>商品名</th>
				<th>数量</th>
				<th>単価</th>
				<th>小計</th>
			</tr>
		</thead>

		<tbody>
			<tr th:each="order : ${orders}">
				<td>
					<img th:src="@{'/images/' + ${order.imageName}}"
						 alt="商品画像"
						 style="width:64px; height:64px; object-fit:cover;"
						 onerror="this.src='/image/no_image.png'">
				</td>

				<td th:text="${order.itemName}"></td>
				<td th:text="${order.quantity}"></td>
				<td th:text="${#numbers.formatInteger(order.price,1,'COMMA')} + '円'"></td>
				<td th:text="${#numbers.formatInteger(order.price * order.quantity,1,'COMMA')} + '円'"></td>
			</tr>

			<tr th:if="${#lists.isEmpty(orders)}">
				<td colspan="5" style="text-align:center; padding:12px; color:#888;">
					注文に商品がありません。
				</td>
			</tr>
		</tbody>
	</table>
	<!-- ===== 戻るボタン ===== -->
	<div class="back-btn-row">
	    <a class="btn btn-cancel back-btn" th:href="@{/admin/orders}">
	        注文一覧に戻る
	    </a>
	</div>
	
	</div>

</section>

</th:block>
</html>
