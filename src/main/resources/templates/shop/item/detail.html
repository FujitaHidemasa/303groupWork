<!DOCTYPE html>
<blohtml xmlns:th="http://www.thymeleaf.org" lang="ja"
	th:replace="layout/shop_base :: base_layout(~{::content}, ${item.name} + '商品詳細', ~{::extraCss})">

	<!-- 固有css/js -->
	<th:block th:fragment="extraCss">
		<link rel="stylesheet" th:href="@{/css/ec/item_detail.css}">
		<script th:src="@{/js/cart.js}" defer></script>
		<script th:src="@{/js/favorite.js}" defer></script>
	</th:block>

	<!-- メインコンテンツ -->
	<th:block th:fragment="content">

		<main>
			<section>
				<h2 class="detail-title" th:text="${item.name}">商品の詳細</h2>

				<div class="product-detail">
					<!-- 商品画像 -->
					<div class="product-image-wrap">
						<img th:src="@{/images/{file}(file=${item.thumbsImageName})}"
							onerror="this.onerror=null;this.src='/images/no_image.png';" alt="商品画像">
					</div>

					<!-- 商品情報 -->
					<div class="product-info-wrap">
						<table class="detail-table">
							<tr>
								<th>商品名</th>
								<td th:text="${item.name}">商品A</td>
							</tr>
							<tr>
								<th>価格</th>
								<td th:text="${#numbers.formatInteger(item.price, 3, 'COMMA')} + '円'"></td>
							</tr>
							<tr>
								<th>商品説明</th>
								<td class="overview-cell" th:text="${item.overview}">説明</td>
							</tr>
							<tr>
								<th>購入</th>
								<td>
									<!-- ★販売中だけボタンを表示 -->
									<div class="action-buttons" th:if="${!item.isDeleted}">
										<!-- カート追加 -->
										<form id="cartForm" th:action="@{/voidrshop/cart/add}" method="post">
											<input type="hidden" th:name="${_csrf.parameterName}"
												th:value="${_csrf.token}" />
											<input type="hidden" name="itemId" th:value="${item.id}">
											<button type="submit" class="cart-add-btn">
												<span class="label">カートに追加</span>
											</button>
										</form>

										<!-- お気に入りボタン -->
										<button type="button" class="favorite-btn"
											th:attr="data-item-id=${item.id}, aria-pressed=${isFavorite}, data-fav=${isFavorite}">
											<span class="star" th:text="${isFavorite} ? '★' : '☆'">☆</span>
											<span class="label">お気に入り</span>
										</button>
									</div>

									<!-- ★削除済み商品の場合のメッセージ -->
									<div th:if="${item.isDeleted}">
										<p class="deleted-text">
											この商品は現在販売を終了しています。（購入履歴としてのみ表示されています）
										</p>
									</div>
								</td>
							</tr>
						</table>
					</div>
				</div>
			</section>

			<section>
				<p class="back-link">
					<a th:href="@{/voidrshop/items}">← 商品一覧に戻る</a>
				</p>
			</section>
		</main>


		<!-- カートポップアップ -->
		<div class="popup-overlay" id="cartPopup">
			<div class="popup-content">
				<h3 style="color:black;">商品をカートに追加しました！</h3>
				<div class="popup-buttons">
					<button class="go-cart" onclick="window.location.href='/voidrshop/cart'">購入画面へ進む</button>
					<button class="close" id="closePopup">戻る</button>
				</div>
			</div>
		</div>

		<!-- カート追加 & お気に入りトグル スクリプト -->
		<script>
			// === 🌟 お気に入りトグル ===（元コードそのまま / クラス名 favorite-btn のまま）
			document.querySelectorAll(".favorite-btn").forEach(btn => {
				btn.addEventListener("click", () => {
					const itemId = btn.getAttribute("data-item-id");

					fetch(`/voidrshop/items/${itemId}/favorite`, {
						method: "POST",
						headers: {"X-Requested-With": "XMLHttpRequest"},
						credentials: "same-origin"
					})
						.then(response => {
							// 未ログインならリダイレクト
							if (response.redirected && response.url.includes("/login")) {
								const currentUrl = window.location.pathname + window.location.search;
								window.location.href = `/login?next=${encodeURIComponent(currentUrl)}`;
								return;
							}
							return response.json();
						})
						.then(data => {
							if (!data) return;
							if (data.status === "ok") {
								const newFav = data.favorite;
								btn.setAttribute("data-fav", newFav);
								btn.querySelector(".star").textContent = newFav ? "★" : "☆";
							}
						})
						.catch(err => console.error("お気に入りエラー:", err));
				});
			});
		</script>

	</th:block>
	</html>