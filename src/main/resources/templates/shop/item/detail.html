<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja"
	th:replace="layout/shop_base :: base_layout(~{::content}, ${item.name} + 'å•†å“è©³ç´°', null)">

<th:block th:fragment="content">

	<main>
		<section>
			<h2 style="text-align: center;" th:text="${item.name}">å•†å“ã®è©³ç´°</h2>

			<div class="product-detail">
				<img th:src="@{/images/{file}(file=${item.thumbsImageName})}"
					onerror="this.onerror=null;this.src='/image/no_image.png';">

				<table>
					<tr>
						<th>å•†å“å</th>
						<td th:text="${item.name}">å•†å“A</td>
					</tr>
					<tr>
						<th>ä¾¡æ ¼</th>
						<td><span th:text="${item.price}"></span>å††</td>
					</tr>
					<tr>
						<th>å•†å“èª¬æ˜</th>
						<td th:text="${item.overview}">èª¬æ˜</td>
					</tr>
					<tr>
						<th>è³¼å…¥</th>
						<td>
							<div class="action-buttons">
								<form id="cartForm" th:action="@{/voidrshop/cart/add}" method="post">
									<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
									<input type="hidden" name="itemId" th:value="${item.id}">
									<button type="submit" class="cart-add-btn">
										<span class="cart-icon">ğŸ›’</span>
										<span class="label">ã‚«ãƒ¼ãƒˆã«è¿½åŠ </span>
									</button>
								</form>

								<button type="button" class="favorite-btn"
									th:attr="data-item-id=${item.id}, aria-pressed=${isFavorite}, data-fav=${isFavorite}">
									<span class="star" th:text="${isFavorite} ? 'â˜…' : 'â˜†'">â˜†</span>
									<span class="label"> ãŠæ°—ã«å…¥ã‚Š</span>
								</button>
							</div>
						</td>
					</tr>
				</table>
			</div>
		</section>

		<section>
			<p style="text-align: center;">
				<a th:href="@{/voidrshop/items}">å•†å“ä¸€è¦§ã«æˆ»ã‚‹</a>
			</p>
		</section>
	</main>

	<style>
		body {
			text-align: center;
			font-family: "Noto Sans JP", "Segoe UI", "Helvetica Neue", sans-serif;
		}

		main {
			max-width: 1000px;
			margin: 30px auto;
			text-align: left;
		}

		.product-detail {
			display: flex;
			justify-content: space-between;
			align-items: flex-start;
			gap: 40px;
			margin: 20px auto;
			width: fit-content;
		}

		.product-detail img {
			width: 400px;
			height: auto;
			border: 1px solid #ccc;
		}

		table {
			border-collapse: collapse;
			width: 450px;
		}

		th,
		td {
			padding: 10px 12px;
			border-bottom: 1px solid #ccc;
			text-align: left;
			vertical-align: top;
		}

		th {
			width: 120px;
			white-space: nowrap;
		}

		.action-buttons {
			display: flex;
			gap: 10px;
			margin-top: 10px;
		}

		.cart-add-btn {
			background-color: #1E40FF;
			color: #fff;
			padding: 10px 18px;
			border-radius: 6px;
			text-decoration: none;
			font-weight: bold;
			display: flex;
			align-items: center;
			gap: 8px;
			border: none;
			cursor: pointer;
			font-size: 15px;
			transition: background-color 0.2s, box-shadow 0.2s;
		}

		.cart-add-btn:hover {
			background-color: #1533CC;
			box-shadow: 0 0 8px rgba(30, 64, 255, 0.4);
		}

		.favorite-btn {
			background: #f5f5f5;
			border: 1px solid #ccc;
			border-radius: 6px;
			padding: 10px 14px;
			cursor: pointer;
			font-weight: bold;
			display: flex;
			align-items: center;
			gap: 4px;
			transition: background-color 0.2s;
		}

		.favorite-btn:hover {
			background-color: #e8e8e8;
		}

		.favorite-btn .star {
			transition: color 0.15s ease;
			font-size: 18px;
		}

		.favorite-btn[data-fav="true"] .star {
			color: #FFD700;
		}

		/* âœ… ã‚«ãƒ¼ãƒˆãƒãƒƒã‚¸ */
		.cart-link {
			position: relative;
			display: inline-block;
		}

		.cart-badge {
			position: absolute;
			top: -6px;
			right: -10px;
			background-color: #ff2e2e;
			color: #fff;
			font-size: 12px;
			font-weight: bold;
			border-radius: 50%;
			width: 18px;
			height: 18px;
			display: flex;
			align-items: center;
			justify-content: center;
			visibility: hidden;
		}

		.cart-badge.active {
			visibility: visible;
		}

		/* âœ… ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å…¨ä½“ */
		.popup-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0, 0, 0, 0.5);
			display: none;
			justify-content: center;
			align-items: center;
			z-index: 1000;
		}

		.popup-content {
			background-color: #fff;
			padding: 25px 35px;
			border-radius: 10px;
			text-align: center;
			box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
			width: 300px;
		}

		.popup-content h3 {
			margin-bottom: 15px;
			color: #000;
			font-weight: bold;
		}

		.popup-buttons {
			display: flex;
			justify-content: space-around;
			margin-top: 20px;
		}

		.popup-buttons button {
			padding: 8px 14px;
			border: none;
			border-radius: 6px;
			cursor: pointer;
			font-weight: bold;
		}

		.popup-buttons .go-cart {
			background-color: #1E40FF;
			color: #fff;
		}

		.popup-buttons .close {
			background-color: #ddd;
			color: #333;
		}
	</style>

	<!-- âœ… ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—HTML -->
	<div class="popup-overlay" id="cartPopup">
		<div class="popup-content">
			<h3>å•†å“ã‚’ã‚«ãƒ¼ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸï¼</h3>
			<div class="popup-buttons">
				<button class="go-cart" onclick="window.location.href='/voidrshop/cart'">è³¼å…¥ç”»é¢ã¸é€²ã‚€</button>
				<button class="close" id="closePopup">æˆ»ã‚‹</button>
			</div>
		</div>
	</div>

	<!-- âœ… ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
	<script>
		document.addEventListener("DOMContentLoaded", () => {
			const cartForm = document.getElementById("cartForm");
			const popup = document.getElementById("cartPopup");
			const closePopup = document.getElementById("closePopup");
			const cartBadge = document.querySelector(".cart-badge");

			cartForm.addEventListener("submit", (e) => {
				e.preventDefault();

				fetch(cartForm.action, {
					method: "POST",
					body: new FormData(cartForm),
				})
					.then(response => {
						if (!response.ok) throw new Error("ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ");
						popup.style.display = "flex";
						updateCartCount(); // âœ… ã‚«ãƒ¼ãƒˆæ•°ã‚’æ›´æ–°
					})
					.catch(err => {
						alert("ã‚«ãƒ¼ãƒˆè¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
						console.error(err);
					});
			});

			closePopup.addEventListener("click", () => {
				popup.style.display = "none";
			});

			// âœ… ã‚«ãƒ¼ãƒˆæ•°ã‚’å–å¾—ã—ã¦ãƒãƒƒã‚¸æ›´æ–°
			function updateCartCount() {
				fetch("/voidrshop/cart/count")
					.then(res => res.json())
					.then(data => {
						if (cartBadge) {
							if (data.count > 0) {
								cartBadge.textContent = data.count;
								cartBadge.classList.add("active");
							} else {
								cartBadge.classList.remove("active");
							}
						}
					})
					.catch(err => console.error("ã‚«ãƒ¼ãƒˆæ•°å–å¾—ã‚¨ãƒ©ãƒ¼:", err));
			}

			updateCartCount(); // âœ… åˆæœŸè¡¨ç¤ºæ™‚ã«ã‚‚æ›´æ–°
		});
	</script>

</th:block>

</html>