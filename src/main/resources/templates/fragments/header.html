<!-- header.html -->
<div th:fragment="header">
	<div class="fixed-header">
		<!-- 紺色帯 -->
		<div class="top-bar">
			<span sec:authorize="isAuthenticated()">
				こんにちは、<span sec:authentication="principal.displayName"></span> さん
				<form th:action="@{/logout}" method="post" class="logout-form"
					style="display:inline; margin-left: 8px;">
					<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
					<button type="submit" class="logout-btn">ログアウト</button>
				</form>
			</span>
			<a th:href="@{/login}" sec:authorize="!isAuthenticated()">ログイン</a>
			<span class="separator">｜</span>
			<a th:href="@{/voidr/contact}">お問い合わせ</a>
		</div>

		<!-- 黒帯 -->
		<header>
			<h1>
				<a th:href="@{/voidrshop}">
					<img th:src="@{/images/ui/header_logo.webp}" alt="Voidr Official Store">
				</a>
			</h1>

			<nav class="header-center">
				<a th:href="@{/voidrshop/items}">商品一覧</a>
				<a th:href="@{/mypage/orders}" sec:authorize="isAuthenticated()">購入履歴</a>
			</nav>

			<div class="header-right">
				<form class="search-box" th:action="@{/voidrshop/items/search}" method="get">
					<input type="text" name="keyword" placeholder="商品を検索" th:value="${keyword}">
					<button type="submit">検索</button>
				</form>

				<!-- お気に入り -->
				<a th:href="@{/favorites/{userId}(userId=${#authentication.principal.id})}" class="cart-link"
					sec:authorize="isAuthenticated()">
					<img th:src="@{/images/ui/header_favoicon.png}" alt="Favorite Icon">
					<span>お気に入り</span>
				</a>

				<!-- ✅ カートアイコン（数字バッジ付き） -->
				<a th:href="@{/voidrshop/cart}" class="cart-link cart-icon-wrap">
					<img th:src="@{/images/ui/header_carticon.png}" alt="Cart Icon">
					<span>カート</span>
					<span id="cart-count" class="cart-count-badge">0</span>
				</a>
			</div>
		</header>
	</div>

	<!-- ✅ カート数取得スクリプト -->
	<script>
		document.addEventListener("DOMContentLoaded", () => {
			const cartCountBadge = document.getElementById("cart-count");
			if (!cartCountBadge) return;

			function updateCartCount() {
				fetch("/voidrshop/cart/count")
					.then(res => res.json())
					.then(data => {
						const count = data.count ?? 0;
						cartCountBadge.textContent = count;
						cartCountBadge.style.display = count > 0 ? "inline-block" : "none";
					})
					.catch(err => console.error("カート数取得エラー:", err));
			}

			updateCartCount(); // 初回読み込み時
			window.addEventListener("cart-updated", updateCartCount); // ✅ 他ページ更新イベントを監視
		});
	</script>

	<!-- ✅ CSS -->
	<style>
		.cart-icon-wrap {
			position: relative;
			display: inline-flex;
			/* ✅ flex に変更 */
			align-items: center;
			/* ✅ アイコンと文字を縦中央揃え */
			gap: 4px;
			/* ✅ アイコンと文字の間隔 */
			padding: 2px 6px;
			/* 必要に応じて余白 */
		}

		.cart-icon-wrap img {
			display: block;
			width: 24px;
			/* アイコンサイズ調整 */
			height: 24px;
			position: relative;
			top: 7px; /* アイコンを少し下に */
		}

		.cart-count-badge {
			position: absolute;
			top: -5px;
			right: -8px;
			background-color: red;
			color: white;
			font-size: 12px;
			font-weight: bold;
			border-radius: 50%;
			padding: 2px 6px;
			min-width: 18px;
			text-align: center;
			line-height: 1.2;
			display: none;
		}
		
		/* お気に入りボタン調整 */
		.cart-link img {
		    display: block;
		    width: 24px;
		    height: 24px;
		    position: relative;
		    top: 2px; /* アイコンを少し下に */
		}

		.cart-link span {
		    vertical-align: middle; /* アイコンに対して文字を中央寄せ */
		}
		
		

	</style>


</div>