<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja"
	th:replace="layout/shop_base :: base_layout(~{::content}, 'お気に入り', ~{})">

<th:block th:fragment="content">
	<main class="fav-container">
		<section class="fav-header">
			<h1>お気に入り</h1>
			<p class="fav-count" th:if="${favorites != null}" th:text="'登録数：' + ${favorites.size()} + '件'">登録数：0件</p>
		</section>

		<!-- 空表示 -->
		<section th:if="${#lists.isEmpty(favorites)}" class="fav-empty">
			<p>まだお気に入りがありません。</p>
			<p><a th:href="@{/voidrshop/items}" class="link">商品一覧へ</a></p>
		</section>

		<!-- 一覧表示 -->
		<section th:if="${!#lists.isEmpty(favorites)}" class="fav-grid">
			<article class="fav-card" th:each="fav : ${favorites}">
				<a class="thumb" th:href="@{'/voidrshop/items/' + ${fav.itemId}}">
					<img th:src="@{/images/{f}(f=${fav.item.thumbsImageName})}" alt="" loading="lazy"
						onerror="this.onerror=null;this.src='/image/no_image.png';" />
				</a>
				<div class="info">
					<a class="name" th:href="@{'/voidrshop/items/' + ${fav.itemId}}" th:text="${fav.item.name}">商品名</a>
					<div class="price" th:text="${#numbers.formatInteger(fav.item.price, 1, 'COMMA')} + '円'">0円</div>
					<div class="meta">
						<time th:text="${#temporals.format(fav.createdAt, 'yyyy/MM/dd HH:mm')}">2025/11/08 12:00</time>
					</div>
				</div>
				<div class="actions">
					<!-- 8割：カートに追加 -->
					<div class="actions-left">
						<!-- fav-cart-form クラス（Ajax & ポップアップ用） -->
						<form th:action="@{/voidrshop/cart/add}" method="post" class="w-100 fav-cart-form">
							<!-- CSRF -->
							<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
							<input type="hidden" name="itemId" th:value="${fav.itemId}" />
							<!-- btn + btn-cart -->
							<button type="submit" class="btn btn-cart w-100" aria-label="カートに追加">
								<svg class="icon" viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
									<path
										d="M7 4h-2l-1 2v2h2l3.6 7.59c.17.33.51.54.88.54h7.02a1 1 0 0 0 .95-.68L21 9H8.42"
										fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
										stroke-linejoin="round" />
									<circle cx="10" cy="20" r="1.5" fill="currentColor" />
									<circle cx="18" cy="20" r="1.5" fill="currentColor" />
								</svg>
								<span>カートに追加</span>
							</button>
						</form>
					</div>

					<!-- 2割：ゴミ箱（削除） -->
					<div class="actions-right">
						<form th:action="@{'/favorites/remove/' + ${fav.userId} + '/' + ${fav.itemId}}" method="post">
							<!-- CSRF -->
							<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

							<!-- ゴミ箱ボタン -->
							<button type="submit"
							        class="bin-button"
							        aria-label="お気に入りから削除"
							        title="削除">
								<svg
									class="bin-top"
									viewBox="0 0 39 7"
									fill="none"
									xmlns="http://www.w3.org/2000/svg">
									<line y1="5" x2="39" y2="5" stroke="white" stroke-width="4"></line>
									<line
										x1="12"
										y1="1.5"
										x2="26.0357"
										y2="1.5"
										stroke="white"
										stroke-width="3"></line>
								</svg>

								<svg
									class="bin-bottom"
									viewBox="0 0 33 39"
									fill="none"
									xmlns="http://www.w3.org/2000/svg">
									<mask id="path-1-inside-1_8_19" fill="white">
										<path
											d="M0 0H33V35C33 37.2091 31.2091 39 29 39H4C1.79086 39 0 37.2091 0 35V0Z">
										</path>
									</mask>
									<path
										d="M0 0H33H0ZM37 35C37 39.4183 33.4183 43 29 43H4C-0.418278 43 -4 39.4183 -4 35H4H29H37ZM4 43C-0.418278 43 -4 39.4183 -4 35V0H4V35V43ZM37 0V35C37 39.4183 33.4183 43 29 43V35V0H37Z"
										fill="white"
										mask="url(#path-1-inside-1_8_19)">
									</path>
									<path d="M12 6L12 29" stroke="white" stroke-width="4"></path>
									<path d="M21 6V29" stroke="white" stroke-width="4"></path>
								</svg>

								<span class="sr-only">削除</span>
							</button>
						</form>
					</div>
				</div>
			</article>
		</section>

		<section class="fav-footer">
			<a th:href="@{/voidrshop/items}" class="link-back">← 商品一覧へ戻る</a>
		</section>
	</main>

	<!-- カート追加ポップアップ（商品詳細と同等のUI） -->
	<div class="popup-overlay" id="cartPopup">
		<div class="popup-content">
			<h3 style="color:black;">商品をカートに追加しました！</h3>
			<div class="popup-buttons">
				<button class="go-cart" onclick="window.location.href='/voidrshop/cart'">
					購入画面へ進む
				</button>
				<button class="close" id="closePopup">戻る</button>
			</div>
		</div>
	</div>

	<!-- お気に入り一覧用 カート追加Ajax & ポップアップ制御 -->
	<script>
		document.addEventListener("DOMContentLoaded", () => {
			const popup = document.getElementById("cartPopup");
			const closePopup = document.getElementById("closePopup");
			const headerCartCount = document.getElementById("cart-count");

			// /favorites 内の「カートに追加」フォーム（複数）を対象
			document.querySelectorAll(".fav-cart-form").forEach(form => {
				form.addEventListener("submit", (e) => {
					e.preventDefault();

					fetch(form.action, {
						method: "POST",
						headers: { "X-Requested-With": "XMLHttpRequest" },
						body: new FormData(form),
						credentials: "same-origin"
					})
						.then(response => {
							// 未ログイン時のリダイレクト検知
							if (response.redirected && response.url.includes("/login")) {
								const currentUrl = window.location.pathname + window.location.search;
								window.location.href = `/login?next=${encodeURIComponent(currentUrl)}`;
								return;
							}

							if (!response.ok) throw new Error("サーバーエラー");
							return response.json();
						})
						.then(data => {
							if (!data) return;

							if (data.status === "ok") {
								// ヘッダーのカート個数バッジを更新
								if (headerCartCount) {
									const count = data.count ?? 0;
									headerCartCount.textContent = count;
									headerCartCount.style.display = (count > 0) ? "inline-block" : "none";
								}

								// ポップアップ表示
								if (popup) {
									popup.style.display = "flex";
								}
							} else {
								alert("カート追加に失敗しました。");
							}
						})
						.catch(err => {
							console.error("カート追加エラー:", err);
						});
				});
			});

			// ポップアップ閉じる処理
			if (closePopup && popup) {
				closePopup.addEventListener("click", () => {
					popup.style.display = "none";
				});

				// 背景クリックで閉じる
				popup.addEventListener("click", (e) => {
					if (e.target === popup) {
						popup.style.display = "none";
					}
				});
			}
		});
	</script>

	<!-- このページ専用の軽量スタイル -->
	<style>
		.fav-container {
			max-width: 1100px;
			margin: 32px auto 48px;
			padding: 0 16px;
		}

		.fav-header {
			display: flex;
			justify-content: space-between;
			align-items: baseline;
			margin-bottom: 16px;
		}

		.fav-count {
			opacity: .8;
			font-size: .95rem;
		}

		.fav-empty {
			text-align: center;
			padding: 48px 0;
		}

		.fav-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
			gap: 16px;
		}

		.fav-card {
			background: rgba(255, 255, 255, 0.04);
			border: 1px solid rgba(255, 255, 255, 0.08);
			border-radius: 12px;
			padding: 12px;
			display: flex;
			flex-direction: column;
			gap: 10px;
		}

		.thumb img {
			width: 100%;
			height: 180px;
			object-fit: cover;
			border-radius: 8px;
			border: 1px solid rgba(255, 255, 255, 0.08);
			background: #111;
		}

		.info {
			display: grid;
			gap: 6px;
		}

		.name {
			font-weight: 600;
			text-decoration: none;
		}

		.name:hover {
			text-decoration: underline;
		}

		.price {
			font-size: 1.05rem;
		}

		.meta {
			font-size: .85rem;
			opacity: .75;
		}

		.actions {
			display: flex;
			gap: 8px;
			margin-top: 4px;
		}

		.btn,
		.btn-outline {
			display: inline-block;
			padding: 8px 12px;
			border-radius: 8px;
			text-decoration: none;
			text-align: center;
			cursor: pointer;
			font-weight: 600;
		}

		.btn {
			background: #1d4ed8;
			color: #fff;
		}

		.btn:hover {
			filter: brightness(1.05);
		}

		.btn-outline {
			background: transparent;
			color: inherit;
			border: 1px solid rgba(255, 255, 255, 0.25);
		}

		.btn-outline:hover {
			background: rgba(255, 255, 255, 0.06);
		}

		.link,
		.link-back {
			text-decoration: none;
		}

		.link:hover,
		.link-back:hover {
			text-decoration: underline;
		}

		/* レイアウト：8:2 割合 */
		.actions {
			display: flex;
			gap: 8px;
			margin-top: 4px;
			align-items: stretch;
		}

		.actions-left {
			flex: 8 1 0;
		}

		.actions-right {
			flex: 2 1 0;
			display: flex;
			justify-content: center;
			align-items: center;
		}

		.w-100 {
			width: 100%;
		}

		/* 既存のボタン系 */
		.btn,
		.btn-outline {
			padding: 8px 12px;
			border-radius: 8px;
			font-weight: 600;
			text-align: center;
			cursor: pointer;
		}

		.btn {
			background: #1d4ed8;
			color: #fff;
		}

		.btn:hover {
			filter: brightness(1.05);
		}

		/* カートボタン */
		.btn-cart {
			display: inline-flex;
			align-items: center;
			justify-content: center;
			gap: 6px;
			width: 100%;
			background: var(--grad-accent);
			color: #fff;
			transition: opacity 0.2s, transform 0.1s;
		}

		.btn-cart:hover {
			opacity: 0.9;
			transform: translateY(-1px);
		}

		.icon {
			vertical-align: -2px;
		}

		/* アイコンボタン（削除）*/
		.btn-icon {
			display: inline-flex;
			align-items: center;
			justify-content: center;
			width: 100%;
			min-width: 38px;
			height: 38px;
			padding: 0;
			border-radius: 8px;
			border: 1px solid rgba(255, 255, 255, 0.25);
			background: transparent;
			color: inherit;
		}

		.btn-icon:hover {
			background: rgba(255, 255, 255, 0.06);
		}

		/* 危険色（削除） */
		.btn-danger {
			border-color: rgba(239, 68, 68, 0.6);
			color: #f87171;
		}

		.btn-danger:hover {
			background: rgba(239, 68, 68, 0.12);
			color: #fca5a5;
		}

		/* スクリーンリーダー用 */
		.sr-only {
			position: absolute;
			width: 1px;
			height: 1px;
			padding: 0;
			margin: -1px;
			overflow: hidden;
			clip: rect(0, 0, 0, 0);
			white-space: nowrap;
			border: 0;
		}

		/* カート追加ポップアップ */
		.popup-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0, 0, 0, 0.55);
			display: none;
			justify-content: center;
			align-items: center;
			z-index: 1000;
		}

		.popup-content {
			background-color: #e9e9e9;
			padding: 25px 35px;
			border-radius: 10px;
			text-align: center;
			width: 300px;
			color: #111;
		}

		.popup-content h3 {
			white-space: nowrap;
			font-size: 1.1rem;
			margin-bottom: 20px;
		}

		.popup-buttons {
			display: flex;
			justify-content: space-around;
			margin-top: 20px;
			gap: 10px;
		}

		.popup-buttons button {
			padding: 8px 14px;
			border: none;
			border-radius: 6px;
			cursor: pointer;
			font-weight: bold;
		}

		.popup-buttons .go-cart {
			background: var(--grad-accent);
			color: #fff;
		}

		.popup-buttons .close {
			background-color: #ccc;
			color: #333;
		}

		/* ゴミ箱ボタン（bin-button） */
		.bin-button {
			display: inline-flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			width: 100%;
			min-width: 38px;
			height: 38px;
			padding: 0;
			border-radius: 8px;
			border: 1px solid rgba(255, 255, 255, 0.25);
			background-color: rgb(255, 95, 95);
			cursor: pointer;
			transition-duration: 0.3s;
			transform: translateY(-7px);
		}

		.bin-bottom {
			width: 14px;
		}

		.bin-top {
			width: 16px;
			transform-origin: right;
			transition-duration: 0.3s;
		}

		.bin-button:hover .bin-top {
			transform: rotate(45deg);
		}

		.bin-button:hover {
			background-color: rgb(255, 0, 0);
		}

		.bin-button:active {
			transform: scale(0.9);
		}

		/* モバイル時は割合だけ少し寄せる */
		@media (max-width: 480px) {
			.actions {
				flex-direction: row;
			}

			.actions-left {
				flex: 7 1 0;
			}

			.actions-right {
				flex: 3 1 0;
			}
		}
	</style>
</th:block>

</html>
