<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" th:href="@{/css/ec/main.css}">
	<link rel="stylesheet" th:href="@{/css/ec/header.css}">
	<link rel="stylesheet" th:href="@{/css/ec/footer.css}">
	<title>購入履歴 - FPS GEAR STORE</title>
	<style>
		body {
			background-color: #111;
			font-family: 'Noto Sans JP', sans-serif;
			color: #f5f5f5;
			line-height: 1.5
		}

		main {
			width: 100%;
			max-width: 900px;
			margin: 40px auto
		}

		h2 {
			text-align: center;
			color: #fff;
			background-color: #000;
			padding: 20px 0;
			border-radius: 12px;
			margin-bottom: 35px;
			font-size: 2.2em;
			box-shadow: 0 4px 12px rgba(0, 0, 0, .6)
		}

		.sort-area {
			display: flex;
			justify-content: flex-end;
			flex-wrap: wrap;
			gap: 10px;
			margin-bottom: 30px
		}

		.sort-area select,
		.sort-area input[type=text],
		.sort-area button {
			padding: 7px 14px;
			border-radius: 6px;
			border: 1px solid #555;
			background-color: #222;
			color: #f5f5f5;
			font-size: 1em
		}

		.order-card {
			background: #1e1e1e;
			border-radius: 12px;
			margin: 22px auto;
			overflow: hidden;
			max-width: 700px;
			box-shadow: 0 6px 20px rgba(0, 0, 0, .6);
			transition: transform .2s ease
		}

		.order-card:hover {
			transform: translateY(-4px)
		}

		.order-header {
			padding: 20px 22px;
			background-color: #222;
			cursor: pointer;
			display: flex;
			flex-direction: column;
			gap: 10px
		}

		.order-header-row {
			display: flex;
			justify-content: space-between;
			flex-wrap: wrap;
			gap: 8px
		}

		.order-header-row.right {
			justify-content: flex-end;
			gap: 25px;
			align-items: center
		}

		.order-header p {
			margin: 0;
			font-weight: 600;
			font-size: 1em;
			color: #f5f5f5
		}

		.order-header span {
			font-weight: bold;
			color: #f5f5f5
		}

		.toggle-icon {
			font-size: 18px;
			transition: transform .3s ease
		}

		.order-header.active .toggle-icon {
			transform: rotate(90deg)
		}

		.order-content {
			display: none;
			padding: 18px 22px;
			animation: fadeIn .3s ease;
			background-color: #2c2c2c
		}

		@keyframes fadeIn {
			from {
				opacity: 0
			}

			to {
				opacity: 1
			}
		}

		.item-card {
			display: flex;
			flex-direction: row;
			align-items: center;
			gap: 16px;
			background-color: #333;
			border-radius: 10px;
			padding: 14px 16px;
			margin-bottom: 14px;
			box-shadow: 0 2px 8px rgba(0, 0, 0, .6)
		}

		.item-card img {
			width: 100px;
			height: 100px;
			object-fit: cover;
			border-radius: 8px;
			flex-shrink: 0;
			border: 1px solid #555
		}

		.item-info {
			flex: 1
		}

		.item-info p {
			margin: 4px 0;
			font-size: 1em;
			color: #f5f5f5
		}

		.item-actions {
			display: flex;
			flex-direction: column;
			gap: 7px
		}

		.item-actions button {
			padding: 7px 14px;
			border: none;
			border-radius: 6px;
			font-weight: 600;
			cursor: pointer;
			font-size: .95em;
			transition: background-color .2s ease
		}

		.item-actions .detail {
			background-color: #00bfff;
			color: #fff
		}

		.item-actions .reorder {
			background-color: #2ecc71;
			color: #fff
		}

		.item-actions button:hover {
			opacity: .9
		}

		.no-history {
			text-align: center;
			margin: 60px auto;
			color: #fff;
			background-color: #000;
			width: fit-content;
			padding: 20px 40px;
			border-radius: 12px;
			font-size: 1.25em;
			font-weight: 600;
			box-shadow: 0 4px 12px rgba(0, 0, 0, .6)
		}

		.cart-actions {
			display: flex;
			justify-content: center;
			gap: 18px;
			margin-top: 45px;
			flex-wrap: wrap
		}

		.cart-actions a {
			text-decoration: none;
			color: #fff;
			background-color: #444;
			padding: 14px 26px;
			border-radius: 8px;
			font-weight: 600;
			border: 1px solid #666;
			transition: background .2s ease
		}

		.cart-actions a:hover {
			background-color: #555
		}

		.flash-message {
			margin: 12px 0;
			padding: 12px 16px;
			border-radius: 6px;
			font-weight: 600;
			font-size: 1em
		}

		.flash-error {
			background-color: #661111;
			color: #ffcccc;
			border: 1px solid #aa4444
		}

		.flash-warning {
			background-color: #665511;
			color: #ffffcc;
			border: 1px solid #aaaa44
		}

		.flash-success {
			background-color: #116611;
			color: #ccffcc;
			border: 1px solid #44aa44
		}

		#cancelPopup {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0, 0, 0, .75);
			display: none;
			justify-content: center;
			align-items: center;
			z-index: 9999
		}

		#cancelPopup .popup-box {
			background: #222;
			padding: 25px 30px;
			border-radius: 12px;
			width: 300px;
			text-align: center;
			box-shadow: 0 0 15px rgba(0, 0, 0, .6)
		}

		#cancelPopup button {
			margin-top: 15px;
			padding: 10px 20px;
			border: none;
			border-radius: 6px;
			cursor: pointer;
			font-weight: bold
		}

		#closeCancelPopup {
			background: #555;
			color: white
		}

		#confirmCancelBtn {
			background: #e74c3c;
			color: white
		}
	</style>
</head>

<body>
	<div th:replace="fragments/header :: header"></div>
	<main>
		<h2>購入履歴</h2>
		<div th:if="${errorMessage}" class="flash-message flash-error"><span th:text="${errorMessage}"></span></div>
		<div th:if="${warningMessage}" class="flash-message flash-warning"><span th:text="${warningMessage}"></span>
		</div>
		<div th:if="${successMessage}" class="flash-message flash-success"><span th:text="${successMessage}"></span>
		</div>
		<div class="sort-area">
			<form method="get" th:action="@{/mypage/orders}">
				<select name="sort" onchange="this.form.submit()">
					<option value="desc" th:selected="${sort == 'desc'}">新しい順</option>
					<option value="asc" th:selected="${sort == 'asc'}">古い順</option>
				</select>
				<input type="text" name="historyKeyword" placeholder="商品名で検索" th:value="${historyKeyword}">
				<button type="submit">検索</button>
			</form>
		</div>

		<div th:if="${groupedOrders != null and !groupedOrders.isEmpty()}" th:each="entry, iterStat : ${groupedOrders}">
			<div class="order-card">
				<div class="order-header" th:onclick="'toggleOrder(' + ${iterStat.index} + ')'">
					<div class="order-header-row">
						<p>注文番号：<span th:text="${entry.key}"></span></p>
						<p th:if="${#lists.size(entry.value) > 0}">注文日：<span
								th:text="${#temporals.format(entry.value[0].createdAt,'yyyy/MM/dd HH:mm')}"></span></p>
						<p>配達予定：<span th:text="${deliveryMap[entry.key]}"></span></p>
					</div>
					<div class="order-header-row right">
						<p>送料：<span th:text="${#numbers.formatInteger(shippingFeeMap[entry.key],0)}"></span>円</p>
						<p>合計：<span th:text="${#numbers.formatInteger(totalPriceMap[entry.key],0)}"></span>円 <span
								class="toggle-icon">▶</span></p>
					</div>
				</div>
				<div class="order-content" th:id="'order-content-' + ${iterStat.index}">
					<div th:if="${statusMap[entry.key] == 'NEW'}" style="margin-bottom:12px;">
						<button class="cancel" th:attr="data-orderListId=${entry.key}"
							style="background-color:#e74c3c;color:white;padding:10px 18px;border:none;border-radius:6px;">この注文をキャンセル</button>
					</div>

					<div th:each="order : ${entry.value}" class="item-card">
						<img th:src="@{'/images/' + ${order.imageName}}"
							onerror="this.onerror=null;this.src='/image/no_image.png';">
						<div class="item-info">
							<p th:text="${order.itemName}"></p>
							<p>数量：<span th:text="${order.quantity}"></span></p>
							<p>価格：¥<span th:text="${#numbers.formatInteger(order.price,0)}"></span></p>
							<p>状態：
								<span th:switch="${statusMap[entry.key]}">
									<span th:case="'NEW'">注文受付</span>
									<span th:case="'SHIPPED'">出荷済み</span>
									<span th:case="'CANCELLED'">キャンセル済み</span>
									<span th:case="*">注文受付</span>
								</span>
							</p>
						</div>
						<div class="item-actions">
							<button class="detail"
								th:onclick="'location.href=\'' + @{/voidrshop/items/{id}(id=${order.itemId})} + '\';'">詳細</button>
							<form th:action="@{/mypage/orders/reorder}" method="post" style="display:inline;">
								<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
								<input type="hidden" name="itemId" th:value="${order.itemId}" />
								<input type="hidden" name="quantity" value="1" />
								<button type="submit" class="reorder">再購入</button>
							</form>
						</div>
					</div>
				</div>
			</div>
		</div>

		<p class="no-history"
			th:if="${historyKeyword != null and historyKeyword != '' and (groupedOrders == null or groupedOrders.isEmpty())}">
			検索結果がありません。</p>
		<p class="no-history"
			th:if="${(historyKeyword == null or historyKeyword == '') and (groupedOrders == null or groupedOrders.isEmpty())}">
			購入履歴がありません。</p>

		<div class="cart-actions">
			<a th:href="@{/voidrshop}">トップページへ戻る</a>
			<a th:href="@{/voidrshop/items}">ストアを見る</a>
		</div>
	</main>

	<div th:replace="fragments/footer :: footer"></div>

	<!-- キャンセルポップアップ -->
	<div id="cancelPopup">
		<div class="popup-box">
			<p>この注文をキャンセルしますか？</p>
			<input type="hidden" id="cancelOrderListId">
			<input type="hidden" id="csrf_header" th:value="${_csrf.parameterName}">
			<input type="hidden" id="csrf_token" th:value="${_csrf.token}">
			<button id="confirmCancelBtn">キャンセルする</button>
			<button id="closeCancelPopup">戻る</button>
		</div>
	</div>

	<script>
		function toggleOrder(index) {
			const content = document.getElementById(`order-content-${index}`);
			const header = content.previousElementSibling;
			if (content.style.display === "block") {
				content.style.display = "none";
				header.classList.remove("active")
			} else {
				content.style.display = "block";
				header.classList.add("active")
			}
		}

		document.addEventListener("DOMContentLoaded", () => {
			const cancelPopup = document.getElementById("cancelPopup");
			const closeCancelPopup = document.getElementById("closeCancelPopup");
			const confirmCancelBtn = document.getElementById("confirmCancelBtn");
			const cancelOrderIdInput = document.getElementById("cancelOrderListId");

			let selectedOrderListId = null;

			// キャンセルボタン押下
			document.querySelectorAll(".cancel").forEach(btn => {
				btn.addEventListener("click", () => {
					selectedOrderListId = btn.dataset.orderlistid;
					cancelOrderIdInput.value = selectedOrderListId; // hidden にセット
					cancelPopup.style.display = "flex";
				})
			});

			// キャンセル確定
			confirmCancelBtn.addEventListener("click", () => {
				const csrfToken = document.getElementById("csrf_token").value;
				const csrfName = document.getElementById("csrf_header").value;

				const form = document.createElement("form");
				form.method = "POST";
				form.action = "/mypage/orders/cancel";

				const csrfInput = document.createElement("input");
				csrfInput.type = "hidden";
				csrfInput.name = csrfName;
				csrfInput.value = csrfToken;

				const idInput = document.createElement("input");
				idInput.type = "hidden";
				idInput.name = "orderListId";
				idInput.value = cancelOrderIdInput.value;

				form.appendChild(csrfInput);
				form.appendChild(idInput);

				document.body.appendChild(form);
				form.submit();
			});

			// ポップアップ閉じる
			closeCancelPopup.addEventListener("click", () => {
				cancelPopup.style.display = "none";
			});
		});
	</script>

</body>

</html>